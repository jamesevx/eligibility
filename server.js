import express from 'express';
import cors from 'cors';
import { config } from 'dotenv';
import { OpenAI } from 'openai';

config();
const app = express();
app.use(cors());
app.use(express.json());

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// Extract US state from address
function extractState(address = '') {
  const match = address.match(/,\s*([A-Z]{2})\s*\d{5}/);
  return match ? match[1] : '';
}

// üåü NEW: Extract city (text between first and second commas)
function extractCity(address = '') {
  // Matches ", Los Angeles, CA"
  const match = address.match(/,\s*([^,]+),\s*[A-Z]{2}\s*\d{5}/);
  return match ? match[1].trim() : '';
}

function todayLong() {
  return new Date().toLocaleDateString(
    'en-US',                       // locale
    { year: 'numeric',
      month: 'long',               // ‚ÄúJuly‚Äù
      day: 'numeric',              // ‚Äú2‚Äù
      timeZone: 'America/New_York' // keep it in your server‚Äôs TZ
    }
  );  // ‚Üí "July 2, 2025"
}

// -------------------- State Abbreviation ‚Üí Full Name --------------------
const stateMap = {
  AL: 'Alabama', AK: 'Alaska', AZ: 'Arizona', AR: 'Arkansas', CA: 'California', CO: 'Colorado', CT: 'Connecticut', DE: 'Delaware', FL: 'Florida', GA: 'Georgia', HI: 'Hawaii', ID: 'Idaho', IL: 'Illinois', IN: 'Indiana', IA: 'Iowa', KS: 'Kansas', KY: 'Kentucky', LA: 'Louisiana', ME: 'Maine', MD: 'Maryland', MA: 'Massachusetts', MI: 'Michigan', MN: 'Minnesota',MS: 'Mississippi', MO: 'Missouri',MT: 'Montana', NE: 'Nebraska', NV: 'Nevada', NH: 'New Hampshire', NJ: 'New Jersey', NM: 'New Mexico', NY: 'New York', NC: 'North Carolina', ND: 'North Dakota', OH: 'Ohio', OK: 'Oklahoma', OR: 'Oregon', PA: 'Pennsylvania', RI: 'Rhode Island', SC: 'South Carolina', SD: 'South Dakota', TN: 'Tennessee', TX: 'Texas', UT: 'Utah', VT: 'Vermont',
  VA: 'Virginia', WA: 'Washington', WV: 'West Virginia', WI: 'Wisconsin', WY: 'Wyoming', DC: 'District of Columbia'
};

// Helper: return full state name, or the original input if not found
function getFullStateName(abbr = '') {
  return stateMap[abbr.toUpperCase()] || abbr;
}

// Format form data into natural project description
function formatProjectDescription(formData) {
  const {
    siteAddress,
    utilityProvider,
    numChargers,
    chargerType,
    chargerKW,
    numPorts,
    portKW,
    publicAccess,
    disadvantagedCommunity,
    usageType,
    vehicleType
  } = formData;

  const chargerStr = numChargers && chargerKW
    ? `${numChargers} ${chargerType || ''} chargers rated at ${chargerKW} kW each,`
    : '';

  const portStr = numPorts && portKW
    ? `with ${numPorts} total ports delivering up to ${portKW} kW per port`
    : '';

  const dacStr = disadvantagedCommunity === 'Yes'
    ? `The site is located in a Disadvantaged Community.`
    : disadvantagedCommunity === 'No'
    ? `The site is not located in a Disadvantaged Community.`
    : '';

  const vehicleStr = vehicleType
    ? `The chargers will service ${vehicleType} vehicles.`
    : '';

  return `
This EV charging project is located at ${siteAddress || 'an unspecified address'} and is served by utility ${utilityProvider || 'unknown'}.
The project includes ${chargerStr} ${portStr}.
It is intended for ${usageType || 'general'} use and provides ${publicAccess || 'unknown'} access to the public.
${dacStr} ${vehicleStr}`.trim();
}

// Main API endpoint using OpenAI's web_search_preview tool
app.post('/api/evaluate', async (req, res) => {
  const { formData } = req.body;
  const formattedInput = formatProjectDescription(formData);

  try {
    const response = await openai.responses.create({
      model: 'gpt-4o',
      temperature: 0.1,
      tools: [{ type: 'web_search_preview', search_context_size: "high"}],
      input: `Estimate available EV charging incentives for the following project:

${formattedInput}

# ACCURACY PRINCIPLE
Treat every numeric incentive value as ‚Äúbest evidence ¬± 25 %‚Äù.  
Never present a single-point dollar figure.  
When sources conflict, cite the lower officially published amount.

---

## Web Search Instructions
Issue *at least* these three searches (add more as needed):

1. "${formData.usageType} ${formData.utilityProvider} EV charger rebates for ${formData.chargerType} charging ${formData.vehicleType} in ${extractState(formData.siteAddress)} ${todayLong()}"
2. "${extractCity(formData.siteAddress)} ${extractState(formData.siteAddress)} public ${formData.chargerType} charging incentives and rebates ${todayLong()}"
3. "${formData.chargerType} rebates ${getFullStateName(extractState(formData.siteAddress))} ${todayLong()}"
4. "${getFullStateName(extractState(formData.siteAddress))} ${formData.chargerType} charger rebate programs available in ${extractCity(formData.siteAddress)} site:.gov OR site:.org ${todayLong()}"
5. "${formData.utilityProvider} ${formData.usageType} ${formData.chargerType} rebate incentive chart pdf site:${formData.utilityProvider.split(' ')[0].toLowerCase()}* ${todayLong()}"
6. "${formData.utilityProvider} ${formData.usageType} ${formData.chargerType} rebate program guide pdf site:${formData.utilityProvider.split(' ')[0].toLowerCase()}* ${todayLong()}"

Follow the research rules for these and any additional searches.

---

### RANGE RULE (mandatory)
For any computed estimate **X**:  
‚Ä¢ *Lower*  = round(X √ó 0.75, ‚àí3)   // nearest $1 000  
‚Ä¢ *Upper*  = round(X √ó 1.25, ‚àí3)  
Display ranges as **$\${Lower/1000}k‚Äì$\${Upper/1000}k**.  
*Example*: 120 000 ‚Üí **$90k‚Äì$150k**

**Exception:**  
Do **not** apply this rule to statutory percentage credits (e.g., ‚Äú30 % of eligible costs, up to $100 000 per charger‚Äù under IRS 30C). Leave those figures unchanged.
---

### INPUT FORMAT
‚Ä¢ Each request may include multiple sites for review.  
‚Ä¢ Input may contain landing pages or attachments (PDF, Excel, images).  
‚Ä¢ Thoroughly examine attachments for hidden terms, caps, or eligibility logic.

---

### RESEARCH RULES
‚úÖ Allowed Sources  
‚ÄÇ‚Ä¢ Utility incentives: official utility domains (coned.com, sce.com, ladwp.com, etc.)  
‚ÄÇ‚Ä¢ State/local funding: *.gov* or trusted *.org* portals  
‚ÄÇ‚Ä¢ Federal programs: IRS, DOE, FHWA, FHWA, etc.  
‚ÄÇ‚Ä¢ Private: foundation or verified clean-energy organizations (e.g., Bloomberg, CALSTART)

‚ùå Forbidden Sources  
‚ÄÇ‚Ä¢ Blogs, third-party aggregators, vendor marketing pages  
‚ÄÇ‚Ä¢ PDFs not hosted on allowed domains  
‚ÄÇ‚Üí If data comes from a non-official source, mark: ‚ÄúNot found on official source.‚Äù

---
### STATE PROGRAM CHECK
If your first pass finds no state-level incentives, perform an extra search:
  "${getFullStateName(extractState(formData.siteAddress))} EV charging incentives ${formData.chargerType}"
If still none are found, state ‚ÄúNot found on official source‚Äù in the output
but keep the section in place.

---

### RECENCY RULE
Only cite documents that list a ‚Äúlast updated,‚Äù ‚Äúrevised,‚Äù or publication date **within the last 18 months**.  
If no date exists, prefer the newest URL (e.g., 2025-, 2024-).  
If two versions conflict, cite both and keep the newer one for calculations.

---

### ELIGIBILITY CRITERIA TO MATCH
‚Ä¢ Number of chargers / ports  
‚Ä¢ Charger type (L2 / DCFC) and kW rating  
‚Ä¢ Public-access status  
‚Ä¢ DAC eligibility  
‚Ä¢ Use case (fleet, multifamily, office, etc.)  
‚Ä¢ Utility territory & network requirement  
‚Ä¢ Zoning / transportation proximity (if applicable)

If any value is unknown, flag it under **Missing Information**.

---

### CALCULATION RULES
‚Ä¢ Apply exact multiplier math when source data gives $/port, $/charger, or $/kW.  
‚ÄÇ (e.g., 6 ports √ó $68 750 if DAC & 240 kW output)  
‚Ä¢ Provide conservative estimates when eligibility is uncertain.  
‚Ä¢ Only show incentives above $1 000.  
‚Ä¢ Collapse tiers & adders into a single total range (use RANGE RULE).

---

### STACKING LOGIC
‚Ä¢ State whether each incentive can be stacked.  
‚Ä¢ If stacking is prohibited or unclear, flag: ‚Äú‚ùå Cannot be stacked‚Äù or ‚ÄúStacking rule unclear ‚Äì proceed with caution.‚Äù  
‚Ä¢ Add a **Stacking Recommendation** block suggesting the optimal combination.

---

### IRS 30C RULE
Display **only**:  
‚Äú30 % of eligible costs, up to $100 000 per charger‚Äù  
‚ö†Ô∏è ‚ÄúProject must meet prevailing wage + apprenticeship requirements.‚Äù  
Link: https://mtgis-portal.geo.census.gov/arcgis/apps/experiencebuilder/experience/?id=dfcab6665ce74efe8cf257aab47ebee1

---

### DOCUMENT PARSING
‚Ä¢ Read every PDF fully; quote key terms with section refs.  
‚Ä¢ When a utility landing page references an ‚ÄúIncentive Chart,‚Äù ‚ÄúProgram Brochure,‚Äù or similar PDF, open it and parse dollar caps before concluding no numeric data exists
‚Ä¢ When data conflicts, cite both but adopt the lower confirmed amount.  
‚Ä¢ Never assume which doc is more accurate without proof.

### ELIGIBILITY VERIFICATION
‚Ä¢ Do **not** infer DAC, zoning, or utility status; provide verification links.  
‚Ä¢ Do not pause for user confirmation ‚Äì just flag and proceed.

### PROGRAM STRUCTURE & TIMING
‚Ä¢ Note pre-application or timing rules.  
‚Ä¢ Flag programs that are paused, exhausted, or pending relaunch.

---

## OUTPUT FORMAT (Client-Ready)

1. üìç **Project Summary** ‚Äì brief, plain-language snapshot using: ${formattedInput}.  

2. üí∞ **Funding Estimate (By Source)**  
   *Example template (use RANGE RULE):*  
   **Utility Funding:** $225k‚Äì$375k  
   6 DCFC ports √ó **$25k‚Äì$40k** per port. DAC required; apply pre-install.  
   Source: ladwp.com | Updated Apr 2025  
   ‚ÄúApplicants must ‚Ä¶‚Äù

3. **Incentive Funding Summary**  
   Utility: $225k‚Äì$375k (Can be stacked)  
   State:  $75k‚Äì$125k (Cannot be stacked)  
   State Tax Credits: up to $5 000 / port  
   Federal Tax Credit: 30 % of eligible costs

4. üîó **Citations**  
   ‚Ä¢ URL  
   ‚Ä¢ Domain  
   ‚Ä¢ Quote  
   ‚Ä¢ Last-updated date

5. ‚ùå **Missing Information** ‚Äì list all unknowns clearly.

6. üìå **Stacking Recommendation** ‚Äì optimal path with caveats.

7. ‚ö†Ô∏è **Disclaimer** ‚Äì ‚ÄúFunding availability is subject to change ‚Ä¶‚Äù

---

### FINAL VALIDATION (perform before responding)
‚Ä¢ Confirm **every** dollar value is a range following RANGE RULE.  
‚Ä¢ Ensure each range cites an allowed domain.  
‚Ä¢ If any violations exist, fix them before sending the answer.

Avoid hallucinations. NEVER assume funding details not on official sources.
`
    });

    // ‚úÖ FIX: Properly extract assistant message from OpenAI response
    let content = 'No response.';
    if (response && Array.isArray(response.output)) {
      const messageItem = response.output.find(item => item.type === 'message');
      if (messageItem?.content?.[0]?.text) {
        content = messageItem.content[0].text;
      }
    }

    res.json({ result: content });

  } catch (error) {
    console.error('OpenAI error:', error);
    res.status(500).json({ error: 'Failed to evaluate funding eligibility' });
  }
});

const PORT = process.env.PORT || 3001;
app.listen(PORT, () => {
  console.log(`API running on port ${PORT}`);
});
